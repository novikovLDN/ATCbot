---
alwaysApply: true
---

You are working on the ATCS (Atlas Secure) codebase.

Strict rules:
- Treat the project as a production-grade fintech + VPN system.
- Never change business logic unless explicitly requested.
- All financial flows must be idempotent and transactional.
- Any change affecting payments, referrals, balance, or subscriptions must:
  - preserve backward compatibility
  - include database-level guarantees (constraints or locks)
- Prefer database constraints over in-memory checks.
- Assume Telegram webhooks and callbacks can be duplicated.
- Stage-first workflow: all changes are designed and tested for STAGE, not PROD.
- Never introduce breaking schema changes without migrations.
- Log every critical decision point using structured logs.
- If unsure, stop and explain risks before proposing code.
